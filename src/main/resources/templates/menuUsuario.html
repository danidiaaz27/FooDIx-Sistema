<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Menú - FoodIx</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/modern-theme.css}">
    <style>
        /* Custom styles for better UX */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            padding: 1rem 0;
        }
        
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
        .filters-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        .cart-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }
        
        .cart-summary {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 100px;
        }
        
        .delivery-info {
            background: rgba(245,166,35,0.05);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid #F5A623;
        }
        
        .payment-methods .form-check {
            background: rgba(198,40,40,0.03);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .payment-methods .form-check:hover {
            background: rgba(198,40,40,0.08);
            border-color: #C62828;
        }
        
        .payment-methods .form-check-input:checked ~ .form-check-label {
            color: #C62828;
            font-weight: 600;
        }
        
        /* Estilos para items del carrito dinámicos */
        .cart-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .cart-items {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

<!-- Barra de Navegación -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="/" th:href="@{/}">
            <img th:src="@{/img/logoFoodix.png}" alt="FoodIx Logo" style="height: 45px; margin-right: 10px;">
            <span style="font-size: 1.6rem; font-weight: 700; color: #C62828; letter-spacing: -0.5px;">FoodIx</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="menuNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <!-- Botón de Tema Claro/Oscuro -->
                <li class="nav-item d-flex align-items-center me-2">
                    <button class="theme-toggle" type="button" aria-label="Cambiar tema">
                        <i class="fas fa-sun"></i>
                        <i class="fas fa-moon"></i>
                    </button>
                </li>
                <li class="nav-item"><a class="nav-link" href="/" th:href="@{/}"><i class="fas fa-home"></i> Inicio</a></li>
                
                <!-- Nuevo: Trabaja con Nosotros -->
                <li class="nav-item">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-briefcase"></i> Trabaja con Nosotros
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/registro-restaurante" th:href="@{/registro-restaurante}">
                                <i class="fas fa-store"></i> Regístrate como Restaurante
                            </a></li>
                            <li><a class="dropdown-item" href="/registro-repartidor" th:href="@{/registro-repartidor}">
                                <i class="fas fa-motorcycle"></i> Regístrate como Delivery
                            </a></li>
                        </ul>
                    </div>
                </li>
                
                <li class="nav-item">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span th:text="${currentUser.name}">Usuario</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/menu" th:href="@{/menu}">
                                <i class="fas fa-utensils"></i> Mi Menú
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#perfilModal">
                                <i class="fas fa-user-cog"></i> Configurar Perfil
                            </a></li>
                            <li>
                                <form th:action="@{/logout}" method="post" style="display: inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="dropdown-item" style="background: none; border: none; cursor: pointer; text-align: left; width: 100%;">
                                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Mensajes Flash como Modales -->
<div th:replace="fragments/flash-messages :: flashMessages"></div>

<!-- Contenido Principal -->
<main class="container-fluid" style="padding-top: 90px;">
    <div class="row">
        <!-- Sidebar de navegación -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="sidebar-content">
                <div class="user-info">
                    <div class="user-avatar" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%);">
                        <i class="fas fa-user-circle fa-3x"></i>
                    </div>
                    <h5 th:text="${currentUser.name + ' ' + currentUser.lastName}" class="mb-1">Usuario</h5>
                    <p class="text-muted mb-0" style="font-size: 0.85rem;" th:text="${currentUser.email}">email@ejemplo.com</p>
                </div>

                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#promociones" data-section="promociones">
                            <i class="fas fa-fire"></i> Promociones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#carrito" data-section="carrito">
                            <i class="fas fa-shopping-cart"></i> 
                            Carrito 
                            <span class="badge ms-2" style="background: #F5A623;" th:text="${cartItemCount}" th:if="${cartItemCount > 0}">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#historial" data-section="historial">
                            <i class="fas fa-history"></i> Historial
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#perfil" data-section="perfil">
                            <i class="fas fa-user"></i> Perfil
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-9 col-lg-10 main-content">
            <!-- Sección Promociones -->
            <section id="promociones-content" class="menu-section active">
                <div class="section-header">
                    <h2><i class="fas fa-fire text-warning"></i> Promociones Especiales</h2>
                    <p class="text-muted">Descubre las mejores ofertas en comida</p>
                </div>

                <!-- Filtros -->
                <div class="filters-section">
                    <h6 class="mb-3" style="color: #C62828; font-weight: 600;">
                        <i class="fas fa-filter"></i> Filtrar Promociones
                    </h6>
                    <form method="post" action="/menu/filter" th:action="@{/menu/filter}" class="row g-3">
                        <div class="col-md-4">
                            <label for="categoryFilter" class="form-label" style="font-weight: 500;">
                                <i class="fas fa-tag" style="color: #F5A623;"></i> Categoría
                            </label>
                            <select class="form-select" id="categoryFilter" name="category" style="border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;">
                                <option value="">Todas las categorías</option>
                                <option th:each="cat : ${categories}" th:value="${cat.key}" th:text="${cat.value}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="priceFilter" class="form-label" style="font-weight: 500;">
                                <i class="fas fa-dollar-sign" style="color: #F5A623;"></i> Precio máximo
                            </label>
                            <select class="form-select" id="priceFilter" name="maxPrice" style="border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;">
                                <option value="">Cualquier precio</option>
                                <option value="10">Hasta S/ 10</option>
                                <option value="20">Hasta S/ 20</option>
                                <option value="30">Hasta S/ 30</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn w-100" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); color: white; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; font-weight: 600;">
                                <i class="fas fa-search"></i> Buscar Ofertas
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Grid de Promociones -->
                <div class="products-grid" id="productsGrid">
                    <!-- Mensaje si no hay promociones -->
                    <div th:if="${promociones == null or promociones.isEmpty()}" class="text-center py-5">
                        <i class="fas fa-tags fa-4x text-muted mb-3"></i>
                        <h4>No hay promociones disponibles</h4>
                        <p class="text-muted">Pronto tendremos nuevas ofertas para ti</p>
                    </div>

                    <!-- Promociones -->
                    <div class="product-card shadow-sm" th:each="promocion : ${promociones}" 
                         style="max-width: 320px; cursor: pointer; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.08);" 
                         th:attr="data-promocion-id=${promocion.codigo}"
                         onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                        
                        <!-- Badge flotante de descuento -->
                        <div th:if="${promocion.precioOriginal != null and promocion.precioOriginal > promocion.precioPromocional}" 
                             style="position: absolute; top: 12px; right: 12px; z-index: 10;">
                            <span class="badge" style="background: linear-gradient(135deg, #C62828 0%, #dc3545 100%); font-size: 0.85rem; padding: 6px 12px; box-shadow: 0 4px 8px rgba(198,40,40,0.3); border-radius: 8px;"
                                  th:text="'-' + ${#numbers.formatDecimal(((promocion.precioOriginal - promocion.precioPromocional) / promocion.precioOriginal * 100), 0, 0)} + '%'">
                                -0%
                            </span>
                        </div>
                        
                        <!-- Imagen mejorada -->
                        <div class="product-image-placeholder" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); height: 180px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; position: relative;">
                            <i class="fas fa-utensils"></i>
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); padding: 15px 12px 8px;">
                                <span class="badge" style="background-color: #F5A623; color: white; font-size: 0.7rem; padding: 3px 10px;" 
                                      th:if="${promocion.categoriaPromocion != null}" 
                                      th:text="${promocion.categoriaPromocion}">Categoría</span>
                            </div>
                        </div>
                        
                        <div class="product-info" style="padding: 15px;">
                            <!-- Header con fecha y restaurante -->
                            <div class="mb-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-store" style="color: #C62828; font-size: 0.75rem; margin-right: 5px;"></i>
                                    <small class="fw-bold text-truncate" style="font-size: 0.8rem; color: #C62828;" th:text="${promocion.restaurante != null ? promocion.restaurante.nombre : 'Restaurante'}">
                                        Restaurante
                                    </small>
                                </div>
                                <small class="text-muted" style="font-size: 0.75rem;" th:if="${promocion.fechaFin != null}">
                                    <i class="fas fa-clock" style="color: #F5A623;"></i> 
                                    Hasta <span th:text="${#dates.format(promocion.fechaFin, 'dd/MM/yyyy')}">fecha</span>
                                </small>
                            </div>
                            
                            <!-- Título optimizado -->
                            <h6 class="product-name mb-2" style="font-size: 1rem; font-weight: 600; line-height: 1.3; height: 2.6rem; overflow: hidden; color: #333;" 
                                th:text="${promocion.titulo}">Nombre de la promoción</h6>
                            
                            <!-- Descripción compacta -->
                            <p class="text-muted mb-3" style="font-size: 0.8rem; line-height: 1.4; height: 2.8rem; overflow: hidden;" 
                               th:text="${promocion.descripcion}">Descripción</p>
                            
                            <!-- Precios destacados -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div th:if="${promocion.precioOriginal != null and promocion.precioOriginal > promocion.precioPromocional}">
                                        <small class="text-decoration-line-through text-muted" style="font-size: 0.75rem;"
                                               th:text="'S/ ' + ${#numbers.formatDecimal(promocion.precioOriginal, 1, 2)}">S/ 0.00</small>
                                    </div>
                                    <div class="fw-bold" style="font-size: 1.5rem; color: #C62828;" 
                                         th:text="'S/ ' + ${#numbers.formatDecimal(promocion.precioPromocional, 1, 2)}">S/ 0.00</div>
                                </div>
                                
                                <!-- Métricas mejoradas -->
                                <div class="text-end" style="line-height: 1.3;">
                                    <div class="text-muted" style="font-size: 0.7rem;">
                                        <i class="fas fa-eye" style="font-size: 0.65rem; color: #17a2b8;"></i> <span th:text="${promocion.contadorVistas}">0</span>
                                    </div>
                                    <div class="text-muted" style="font-size: 0.7rem;">
                                        <i class="fas fa-shopping-bag" style="font-size: 0.65rem; color: #28a745;"></i> <span th:text="${promocion.contadorPedidos}">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Call to action -->
                            <div class="text-center pt-2" style="border-top: 1px solid rgba(0,0,0,0.08);">
                                <span style="font-size: 0.8rem; color: #F5A623; font-weight: 500;">
                                    <i class="fas fa-mouse-pointer"></i> Click para ver más detalles
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección Carrito -->
            <section id="carrito-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> Mi Carrito</h2>
                    <p class="text-muted">Revisa tus productos antes de realizar el pedido</p>
                </div>

                <!-- Carrito vacío -->
                <div class="empty-cart text-center py-5" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(198,40,40,0.1) 0%, rgba(245,166,35,0.1) 100%); border-radius: 50%; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                        <i class="fas fa-shopping-cart fa-4x" style="color: #C62828;"></i>
                    </div>
                    <h4 style="color: #C62828;">Tu carrito está vacío</h4>
                    <p class="text-muted mb-4">¡Agrega algunas promociones deliciosas desde nuestro menú!</p>
                    <button type="button" class="btn btn-primary" onclick="showMenuSection('promociones')" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600;">
                        <i class="fas fa-fire"></i> Ver Promociones
                    </button>
                </div>

                <!-- Carrito con productos -->
                <div class="cart-content" style="display: none;">
                    <div class="cart-items">
                        <!-- Los items se cargarán dinámicamente con JavaScript -->
                    </div>

                    <div class="cart-summary">
                        <!-- Información de entrega -->
                        <div class="delivery-info mb-3">
                            <h6><i class="fas fa-map-marker-alt"></i> Dirección de entrega</h6>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="direccionEntrega" 
                                       th:value="${currentUser['address']}" 
                                       placeholder="Ingresa tu dirección para delivery">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Solo para pedidos con delivery
                                </small>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="telefonoContacto" 
                                       th:value="${currentUser['phone']}" 
                                       placeholder="Teléfono de contacto">
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" id="referenciaEntrega" rows="2" 
                                          placeholder="Referencias adicionales (opcional)"></textarea>
                            </div>
                        </div>

                        <div class="cart-total">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span class="subtotal-value">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Costo de delivery:</span>
                                <span class="delivery-value">S/ 0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <h4>Total:</h4>
                                <h4 class="text-primary total-value">S/ 0.00</h4>
                            </div>
                        </div>
                        
                        <div class="payment-methods">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Método de pago:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" value="efectivo" id="efectivo" checked>
                                    <label class="form-check-label" for="efectivo">
                                        <i class="fas fa-money-bill-wave"></i> Efectivo
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" value="tarjeta" id="tarjeta">
                                    <label class="form-check-label" for="tarjeta">
                                        <i class="fas fa-credit-card"></i> Tarjeta
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" value="yape" id="yape">
                                    <label class="form-check-label" for="yape">
                                        <i class="fas fa-mobile-alt"></i> Yape
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" value="plin" id="plin">
                                    <label class="form-check-label" for="plin">
                                        <i class="fas fa-mobile-alt"></i> Plin
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Notas especiales -->
                            <div class="mb-3">
                                <label for="notasEspeciales" class="form-label">Notas especiales (opcional)</label>
                                <textarea class="form-control" id="notasEspeciales" 
                                          rows="2" placeholder="Instrucciones especiales para tu pedido..."></textarea>
                            </div>
                            
                            <button type="button" class="btn btn-success btn-lg w-100" onclick="realizarPedido()">
                                <i class="fas fa-check-circle"></i> Confirmar Pedido
                            </button>
                                    <i class="fas fa-credit-card"></i> Realizar Pedido
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección Historial -->
            <section id="historial-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Historial de Pedidos</h2>
                    <p class="text-muted">Revisa tus pedidos anteriores</p>
                </div>

                <!-- Lista de pedidos que se carga dinámicamente -->
                <div id="pedidos-lista" class="orders-list">
                    <!-- Se llenará con JavaScript -->
                </div>

                <div id="pedidos-vacio" class="empty-history text-center py-5" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(198,40,40,0.1) 0%, rgba(245,166,35,0.1) 100%); border-radius: 50%; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                        <i class="fas fa-history fa-3x" style="color: #C62828;"></i>
                    </div>
                    <h4 style="color: #C62828;">No tienes pedidos anteriores</h4>
                    <p class="text-muted">Tus pedidos aparecerán aquí una vez que realices tu primera compra</p>
                </div>
            </section>

            <!-- Sección Perfil -->
            <section id="perfil-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-user"></i> Mi Perfil</h2>
                    <p class="text-muted">Administra tu información personal</p>
                </div>

                <div class="profile-info">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="info-card shadow-sm" style="background: var(--card-bg); border-radius: 12px; padding: 2rem; border: 1px solid rgba(0,0,0,0.08); height: 100%;">
                                <div class="d-flex align-items-center mb-3">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <i class="fas fa-user fa-lg" style="color: white;"></i>
                                    </div>
                                    <h5 class="mb-0" style="color: #C62828; font-weight: 600;">Información Personal</h5>
                                </div>
                                <div class="info-item mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-user-tag" style="color: #F5A623; width: 20px;"></i> Nombre completo</small>
                                    <strong th:text="${currentUser.name + ' ' + currentUser.lastName}">Nombre completo</strong>
                                </div>
                                <div class="info-item mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-envelope" style="color: #F5A623; width: 20px;"></i> Email</small>
                                    <strong th:text="${currentUser.email}">email@ejemplo.com</strong>
                                </div>
                                <div class="info-item mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-phone" style="color: #F5A623; width: 20px;"></i> Teléfono</small>
                                    <strong th:text="${currentUser.phone ?: 'No especificado'}">Teléfono</strong>
                                </div>
                                <div class="info-item">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-map-marker-alt" style="color: #F5A623; width: 20px;"></i> Dirección</small>
                                    <strong th:text="${currentUser.address ?: 'No especificada'}">Dirección</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="stats-card shadow-sm" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); border-radius: 12px; padding: 2rem; color: white; height: 100%;">
                                <div class="d-flex align-items-center mb-4">
                                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <i class="fas fa-chart-line fa-lg"></i>
                                    </div>
                                    <h5 class="mb-0" style="font-weight: 600;">Estadísticas</h5>
                                </div>
                                <div class="stat-item mb-3 pb-3" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-shopping-bag me-2"></i> Pedidos realizados</span>
                                        <span class="fs-4 fw-bold" th:text="${pedidos != null ? pedidos.size() : 0}">0</span>
                                    </div>
                                </div>
                                <div class="stat-item mb-3 pb-3" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-shopping-cart me-2"></i> Productos en carrito</span>
                                        <span class="fs-4 fw-bold" th:text="${cartItemCount ?: 0}">0</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-dollar-sign me-2"></i> Total gastado</span>
                                        <span class="fs-4 fw-bold">
                                            <span th:if="${pedidos != null and !pedidos.isEmpty()}" 
                                                  th:text="'S/ ' + ${#numbers.formatDecimal(pedidos.![total].sum(), 1, 2)}">S/ 0.00</span>
                                            <span th:if="${pedidos == null or pedidos.isEmpty()}">S/ 0.00</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<!-- Botón Flotante del Carrito -->
<div class="floating-cart-btn" id="floatingCartBtn" style="display: none; position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
    <button class="btn btn-floating shadow-lg" data-bs-toggle="modal" data-bs-target="#cartPreviewModal" 
            style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); color: white; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1rem; transition: all 0.3s ease;"
            onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 8px 20px rgba(198,40,40,0.4)';"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='';">
        <i class="fas fa-shopping-cart fa-lg"></i>
        <span class="cart-count badge" id="floatingCartCount" 
              style="position: absolute; top: -5px; right: -5px; background: white; color: #C62828; font-weight: 700; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">0</span>
        <div class="cart-total mt-1" id="floatingCartTotal" style="font-size: 0.85rem; font-weight: 600;">S/ 0.00</div>
    </button>
</div>

<!-- Modal de Preview del Carrito -->
<div class="modal fade" id="cartPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart"></i> Mi Carrito - Resumen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cartPreviewContent">
                    <!-- Contenido dinámico del carrito -->
                    <div class="text-center text-muted py-4" id="emptyCartMessage">
                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                        <p>Tu carrito está vacío</p>
                        <p>¡Agrega algunos productos deliciosos!</p>
                    </div>
                    
                    <div id="cartItemsList" style="display: none;">
                        <!-- Los items se cargarán aquí dinámicamente -->
                    </div>
                    
                    <div id="cartSummary" style="display: none;">
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Total a pagar:</h5>
                            <h4 class="text-primary mb-0" id="modalCartTotal">S/ 0.00</h4>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                                    <i class="fas fa-arrow-left"></i> Seguir Comprando
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-success w-100" id="proceedToCheckout">
                                    <i class="fas fa-credit-card"></i> Realizar Pago
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Perfil -->
<div class="modal fade" id="perfilModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-cog"></i> Configurar Perfil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/auth/update-profile" th:action="@{/auth/update-profile}" method="post">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Actualiza tu información personal
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileName" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="profileName" name="name" 
                                   th:value="${currentUser?.name}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profileLastName" class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="profileLastName" name="lastName" 
                                   th:value="${currentUser?.lastName}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="profileEmail" name="email" 
                                   th:value="${currentUser?.email}" required readonly>
                            <div class="form-text">El email no se puede cambiar</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profilePhone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="profilePhone" name="phone" 
                                   th:value="${currentUser?.phone}" placeholder="Ej: +51 987654321">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileBirthdate" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="profileBirthdate" name="birthdate" 
                                   th:value="${currentUser?.birthdate}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profileNewPassword" class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="profileNewPassword" name="newPassword" 
                                   placeholder="Dejar vacío para no cambiar" minlength="6">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="profileAddress" class="form-label">Dirección</label>
                        <textarea class="form-control" id="profileAddress" name="address" rows="2" 
                                  th:text="${currentUser?.address}" placeholder="Ej: Av. Balta 123, Chiclayo"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalle de Promoción -->
<div class="modal fade" id="promocionModal" tabindex="-1" aria-labelledby="promocionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%);">
                <h5 class="modal-title" id="promocionModalLabel">
                    <i class="fas fa-gift"></i> Detalles de la Promoción
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Imagen de la promoción -->
                    <div class="col-md-5 mb-3">
                        <div class="position-relative">
                            <div class="product-image-placeholder" style="background: linear-gradient(135deg, #C62828 0%, #F5A623 100%); height: 280px; display: flex; align-items: center; justify-content: center; color: white; font-size: 4rem; border-radius: 12px;">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <span class="badge bg-danger position-absolute" style="top: 10px; right: 10px; font-size: 1rem; padding: 8px 12px;" id="modalDescuento">
                                -0%
                            </span>
                        </div>
                    </div>
                    
                    <!-- Información de la promoción -->
                    <div class="col-md-7">
                        <div class="mb-3">
                            <span class="badge mb-2" style="background-color: #F5A623;" id="modalCategoria">Categoría</span>
                            <span class="badge bg-success ms-1" id="modalEstado">Estado</span>
                        </div>
                        
                        <!-- Nombre del restaurante -->
                        <div class="alert alert-light border-0 py-2 px-3 mb-3" style="background: rgba(198,40,40,0.05);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-store" style="color: #C62828; font-size: 1.2rem; margin-right: 10px;"></i>
                                <div>
                                    <div class="fw-bold" style="color: #C62828; font-size: 1rem;" id="modalNombreRestaurante">Restaurante</div>
                                    <small class="text-muted" id="modalDireccionRestaurante" style="font-size: 0.8rem;"></small>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="fw-bold mb-3" id="modalTitulo">Título de la Promoción</h3>
                        
                        <p class="text-muted mb-3" id="modalDescripcion">
                            Descripción detallada de la promoción...
                        </p>
                        
                        <!-- Precios -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-3">
                                <div style="display: none;">
                                    <small class="text-decoration-line-through text-muted">
                                        Antes: <span id="modalPrecioOriginal">S/ 0.00</span>
                                    </small>
                                </div>
                                <div>
                                    <h2 class="fw-bold mb-0" style="color: #C62828;">
                                        <span id="modalPrecioPromocion">S/ 0.00</span>
                                    </h2>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fechas de vigencia -->
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body py-2">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">
                                            <i class="fas fa-calendar-check"></i> Inicio
                                        </small>
                                        <strong id="modalFechaInicio">--/--/----</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">
                                            <i class="fas fa-calendar-times"></i> Fin
                                        </small>
                                        <strong id="modalFechaFin">--/--/----</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estadísticas -->
                        <div class="row g-2 mb-3">
                            <div class="col-4">
                                <div class="card text-center border-0 bg-light">
                                    <div class="card-body py-2">
                                        <i class="fas fa-eye" style="color: #C62828;"></i>
                                        <div class="fw-bold" id="modalVistas">0</div>
                                        <small class="text-muted">Vistas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center border-0 bg-light">
                                    <div class="card-body py-2">
                                        <i class="fas fa-shopping-bag" style="color: #F5A623;"></i>
                                        <div class="fw-bold" id="modalPedidos">0</div>
                                        <small class="text-muted">Pedidos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center border-0 bg-light">
                                    <div class="card-body py-2">
                                        <i class="fas fa-ticket-alt" style="color: #C62828;"></i>
                                        <div class="fw-bold" id="modalCanjeos">0</div>
                                        <small class="text-muted">Canjeos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Restricciones y condiciones -->
                <div class="mt-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Restricciones y Condiciones
                    </h6>
                    <ul class="list-unstyled mb-0" id="modalRestricciones">
                        <li><i class="fas fa-info-circle text-info"></i> Cargando...</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn" style="background-color: #C62828; color: white; border: none;" id="btnAgregarPromocion" onclick="agregarPromocionAlCarrito()">
                    <i class="fas fa-cart-plus"></i> Agregar al Carrito
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/theme-toggle.js}"></script>
<script th:src="@{/js/main.js}"></script>
<script>
// JavaScript para funcionalidades específicas del menú
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar botón flotante del carrito
    updateFloatingCart();
    
    // Manejar cambios en tipo de entrega
    document.querySelectorAll('input[name^="tipoEntrega_"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateCartSummary();
        });
    });

    // Navegación entre secciones
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('href').substring(1);
            showMenuSection(section);
        });
    });
    
    // Event listener para las tarjetas de promoción
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.product-card[data-promocion-id]');
        if (card) {
            const codigoPromocion = card.getAttribute('data-promocion-id');
            mostrarDetallePromocion(codigoPromocion);
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('promocionModal'));
            modal.show();
        }
    });
    
    // Cargar carrito al iniciar
    cargarCarrito();
});

function showMenuSection(sectionName) {
    // Ocultar todas las secciones
    document.querySelectorAll('.menu-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remover active de todos los links
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar sección seleccionada
    document.getElementById(sectionName + '-content').classList.add('active');
    
    // Activar link correspondiente
    document.querySelector(`.sidebar .nav-link[href="#${sectionName}"]`).classList.add('active');
}

function updateFloatingCart() {
    fetch('/cart/summary')
        .then(response => response.json())
        .then(data => {
            const floatingBtn = document.getElementById('floatingCartBtn');
            const cartCount = document.getElementById('floatingCartCount');
            const cartTotal = document.getElementById('floatingCartTotal');
            
            if (data.itemCount > 0) {
                floatingBtn.style.display = 'block';
                cartCount.textContent = data.itemCount;
                cartTotal.textContent = 'S/ ' + data.total.toFixed(2);
            } else {
                floatingBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.log('Error al cargar resumen del carrito:', error);
        });
}

function updateCartSummary() {
    // Recalcular costos basado en tipo de entrega seleccionado
    const deliveryItems = document.querySelectorAll('input[name^="tipoEntrega_"]:checked[value="DELIVERY"]').length;
    const deliveryCost = deliveryItems > 0 ? 5.90 : 0;
    
    // Actualizar el elemento que muestra el costo de delivery
    const deliveryCostElement = document.querySelector('[th\\:text*="deliveryCost"]');
    if (deliveryCostElement) {
        deliveryCostElement.textContent = 'S/ ' + deliveryCost.toFixed(2);
    }
    
    // Actualizar total
    const cartTotalElement = document.querySelector('[th\\:text*="cartTotal"]');
    const cartSubtotalElement = document.querySelector('[th\\:text*="cartSubtotal"]');
    
    if (cartTotalElement && cartSubtotalElement) {
        const subtotalText = cartSubtotalElement.textContent.replace('S/ ', '');
        const subtotal = parseFloat(subtotalText) || 0;
        const newTotal = subtotal + deliveryCost;
        cartTotalElement.textContent = 'S/ ' + newTotal.toFixed(2);
    }
}

function calificarPedido(pedidoId) {
    const rating = prompt('Califica este pedido (1-5 estrellas):');
    if (rating && rating >= 1 && rating <= 5) {
        const comentario = prompt('Comentario adicional (opcional):') || '';
        
        fetch(`/pedidos/${pedidoId}/calificar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('[name="_csrf"]').value
            },
            body: JSON.stringify({
                calificacion: parseInt(rating),
                comentario: comentario
            })
        }).then(response => {
            if (response.ok) {
                alert('¡Gracias por tu calificación!');
                location.reload();
            } else {
                alert('Error al enviar la calificación');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error al enviar la calificación');
        });
    }
}

// Función para mostrar detalles de promoción en modal
function mostrarDetallePromocion(codigoPromocion) {
    // Hacer una petición al servidor para obtener los detalles de la promoción
    fetch(`/promociones/api/promociones/${codigoPromocion}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener la promoción');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.promocion) {
                mostrarDatosPromocionEnModal(data.promocion, codigoPromocion);
            } else {
                throw new Error(data.error || 'Promoción no encontrada');
            }
        })
        .catch(error => {
            console.error('Error al cargar promoción:', error);
            alert('Error al cargar los detalles de la promoción');
        });
}

function mostrarDatosPromocionEnModal(promocion, codigoPromocion) {
    if (!promocion) {
        console.error('Promoción no encontrada');
        return;
    }
    
    // Información del restaurante
    document.getElementById('modalNombreRestaurante').textContent = promocion.nombreRestaurante || 'Restaurante';
    const direccionElement = document.getElementById('modalDireccionRestaurante');
    if (promocion.direccionRestaurante) {
        direccionElement.textContent = promocion.direccionRestaurante;
        direccionElement.style.display = 'block';
    } else {
        direccionElement.style.display = 'none';
    }
    
    // Calcular descuento
    const tieneDescuento = promocion.precioOriginal && promocion.precioOriginal > promocion.precioPromocional;
    const porcentajeDescuento = tieneDescuento 
        ? Math.round(((promocion.precioOriginal - promocion.precioPromocional) / promocion.precioOriginal) * 100)
        : 0;
    
    // Actualizar contenido del modal
    document.getElementById('modalTitulo').textContent = promocion.titulo;
    document.getElementById('modalCategoria').textContent = promocion.categoriaPromocion || 'Sin categoría';
    document.getElementById('modalDescripcion').textContent = promocion.descripcion || 'Sin descripción disponible';
    
    // Precio
    const modalPrecioOriginal = document.getElementById('modalPrecioOriginal');
    const modalDescuento = document.getElementById('modalDescuento');
    if (tieneDescuento) {
        modalPrecioOriginal.textContent = 'S/ ' + promocion.precioOriginal.toFixed(2);
        modalPrecioOriginal.parentElement.style.display = 'block';
        modalDescuento.textContent = '-' + porcentajeDescuento + '%';
        modalDescuento.style.display = 'inline-block';
    } else {
        modalPrecioOriginal.parentElement.style.display = 'none';
        modalDescuento.style.display = 'none';
    }
    document.getElementById('modalPrecioPromocion').textContent = 'S/ ' + promocion.precioPromocional.toFixed(2);
    
    // Fechas
    const fechaInicio = promocion.fechaInicio ? new Date(promocion.fechaInicio).toLocaleDateString('es-PE') : 'No especificado';
    const fechaFin = promocion.fechaFin ? new Date(promocion.fechaFin).toLocaleDateString('es-PE') : 'No especificado';
    document.getElementById('modalFechaInicio').textContent = fechaInicio;
    document.getElementById('modalFechaFin').textContent = fechaFin;
    
    // Restricciones
    const restricciones = [];
    if (promocion.cantidadMinima) restricciones.push(`Cantidad mínima: ${promocion.cantidadMinima}`);
    if (promocion.cantidadMaxima) restricciones.push(`Cantidad máxima: ${promocion.cantidadMaxima}`);
    if (promocion.limiteCanjeos) restricciones.push(`Límite de canjeos: ${promocion.limiteCanjeos}`);
    
    const restriccionesHtml = restricciones.length > 0 
        ? restricciones.map(r => `<li><i class="fas fa-info-circle text-info"></i> ${r}</li>`).join('')
        : '<li class="text-muted"><i>Sin restricciones especiales</i></li>';
    document.getElementById('modalRestricciones').innerHTML = restriccionesHtml;
    
    // Métricas
    document.getElementById('modalVistas').textContent = promocion.contadorVistas || 0;
    document.getElementById('modalPedidos').textContent = promocion.contadorPedidos || 0;
    document.getElementById('modalCanjeos').textContent = 0; // Por ahora siempre 0
    
    // Estado y botón
    const estadoElement = document.getElementById('modalEstado');
    const btnAgregar = document.getElementById('btnAgregarPromocion');
    
    if (promocion.estado === 'activa') {
        estadoElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Activa</span>';
        btnAgregar.disabled = false;
        btnAgregar.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
    } else {
        estadoElement.innerHTML = '<span class="badge bg-secondary"><i class="fas fa-times-circle"></i> No Disponible</span>';
        btnAgregar.disabled = true;
        btnAgregar.innerHTML = '<i class="fas fa-ban"></i> No Disponible';
    }
    
    // Guardar código de promoción en el botón
    btnAgregar.setAttribute('data-promocion-codigo', codigoPromocion);
}

// Función para agregar promoción al carrito desde el modal
function agregarPromocionAlCarrito() {
    const codigo = document.getElementById('btnAgregarPromocion').getAttribute('data-promocion-codigo');
    const btnAgregar = document.getElementById('btnAgregarPromocion');
    
    // Deshabilitar botón mientras se procesa
    btnAgregar.disabled = true;
    btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
    
    fetch('/api/carrito/agregar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `codigoPromocion=${codigo}&cantidad=1`
    })
    .then(response => response.json())
    .then(data => {
        console.log('✅ Respuesta agregar:', data);
        if (data.success) {
            // Mostrar mensaje de éxito
            mostrarNotificacion('✅ Promoción agregada al carrito', 'success');
            
            // Recargar el carrito
            cargarCarrito();
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('promocionModal'));
            if (modal) modal.hide();
            
            // Cambiar a la sección del carrito si el usuario lo desea
            setTimeout(() => {
                if (confirm('¿Deseas ver tu carrito ahora?')) {
                    showMenuSection('carrito');
                }
            }, 500);
        } else {
            mostrarNotificacion('❌ ' + (data.message || 'Error al agregar al carrito'), 'error');
            btnAgregar.disabled = false;
            btnAgregar.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('❌ Error al agregar al carrito', 'error');
        btnAgregar.disabled = false;
        btnAgregar.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
    });
}

// Función para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo) {
    // Crear notificación temporal
    const notif = document.createElement('div');
    notif.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} position-fixed`;
    notif.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notif.innerHTML = mensaje;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.remove();
    }, 3000);
}

// Función para actualizar contador del carrito
function actualizarContadorCarrito(count) {
    const contador = document.querySelector('#carrito-content .nav-link .badge');
    if (contador) {
        contador.textContent = count;
    }
    const floatingCount = document.getElementById('floatingCartCount');
    if (floatingCount) {
        floatingCount.textContent = count;
    }
}

// Función para cargar el carrito
function cargarCarrito() {
    console.log('🛒 Cargando carrito...');
    fetch('/api/carrito/resumen')
        .then(response => {
            console.log('📦 Respuesta:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('✅ Datos:', data);
            if (data.success) {
                console.log('📋 Items:', data.items.length);
                renderizarCarrito(data.items, data.totales);
                actualizarContadorCarrito(data.items.length);
            }
        })
        .catch(error => console.error('❌ Error:', error));
}

// Función para renderizar el carrito
function renderizarCarrito(items, totales) {
    console.log('🎨 Renderizando carrito con', items.length, 'items');
    
    const carritoContainer = document.querySelector('#carrito-content .cart-items');
    const emptyCart = document.querySelector('#carrito-content .empty-cart');
    const cartContent = document.querySelector('#carrito-content .cart-content');
    
    console.log('📍 Elementos encontrados:', {
        carritoContainer: !!carritoContainer,
        emptyCart: !!emptyCart,
        cartContent: !!cartContent
    });
    
    if (!carritoContainer) {
        console.warn('⚠️ No se encontró .cart-items');
        return;
    }
    
    if (items.length === 0) {
        console.log('📭 Carrito vacío');
        if (emptyCart) emptyCart.style.display = 'block';
        if (cartContent) cartContent.style.display = 'none';
    } else {
        console.log('📦 Mostrando', items.length, 'items');
        if (emptyCart) emptyCart.style.display = 'none';
        if (cartContent) cartContent.style.display = 'block';
        
        carritoContainer.innerHTML = items.map(item => `
            <div class="cart-item" data-promocion="${item.codigoPromocion}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.tituloPromocion}</h6>
                        <small class="text-muted"><i class="fas fa-store"></i> ${item.nombreRestaurante}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="eliminarDelCarrito(${item.codigoPromocion})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group" style="width: 120px;">
                        <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad(${item.codigoPromocion}, ${item.cantidad - 1})">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control form-control-sm text-center" value="${item.cantidad}" readonly>
                        <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad(${item.codigoPromocion}, ${item.cantidad + 1})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="text-end">
                        <div class="text-muted" style="font-size: 0.8rem;">S/ ${item.precioUnitario.toFixed(2)} c/u</div>
                        <div class="fw-bold" style="color: #C62828;">S/ ${item.subtotal.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Actualizar totales
        document.querySelector('.cart-summary .subtotal-value').textContent = 'S/ ' + totales.subtotal.toFixed(2);
        document.querySelector('.cart-summary .delivery-value').textContent = 'S/ ' + totales.costoDelivery.toFixed(2);
        document.querySelector('.cart-summary .total-value').textContent = 'S/ ' + totales.total.toFixed(2);
        
        // Actualizar contador
        actualizarContadorCarrito(totales.itemCount);
    }
}

// Función para cambiar cantidad
function cambiarCantidad(codigoPromocion, nuevaCantidad) {
    if (nuevaCantidad < 1) return;
    
    fetch(`/api/carrito/actualizar/${codigoPromocion}?cantidad=${nuevaCantidad}`, {
        method: 'PUT'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cargarCarrito();
        } else {
            mostrarNotificacion('❌ ' + (data.message || 'Error al actualizar cantidad'), 'error');
        }
    })
    .catch(error => console.error('Error:', error));
}

// Función para eliminar del carrito
function eliminarDelCarrito(codigoPromocion) {
    if (!confirm('¿Eliminar este item del carrito?')) return;
    
    fetch(`/api/carrito/eliminar/${codigoPromocion}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion('✅ Item eliminado', 'success');
            cargarCarrito();
        } else {
            mostrarNotificacion('❌ Error al eliminar', 'error');
        }
    })
    .catch(error => console.error('Error:', error));
}

// Función para realizar el pedido
function realizarPedido() {
    const direccion = document.getElementById('direccionEntrega').value.trim();
    const telefono = document.getElementById('telefonoContacto').value.trim();
    const referencia = document.getElementById('referenciaEntrega').value.trim();
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;
    const notas = document.getElementById('notasEspeciales').value.trim();
    
    // Validar campos requeridos
    if (!direccion) {
        mostrarNotificacion('❌ Ingresa una dirección de entrega', 'error');
        document.getElementById('direccionEntrega').focus();
        return;
    }
    
    if (!telefono) {
        mostrarNotificacion('❌ Ingresa un teléfono de contacto', 'error');
        document.getElementById('telefonoContacto').focus();
        return;
    }
    
    // Crear objeto de pedido
    const pedidoData = {
        direccionEntrega: direccion + (referencia ? ' - ' + referencia : ''),
        telefono: telefono,
        metodoPago: metodoPago,
        notas: notas || ''
    };
    
    // Botón
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    
    // Enviar pedido
    fetch('/api/carrito/crear-pedido', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(pedidoData)
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
        
        if (data.success) {
            // Limpiar campos
            document.getElementById('direccionEntrega').value = '';
            document.getElementById('telefonoContacto').value = '';
            document.getElementById('referenciaEntrega').value = '';
            document.getElementById('notasEspeciales').value = '';
            
            // Mostrar modal de confirmación
            mostrarModalPedido(data.numeroPedido, data.codigoVerificacion);
            
            // Recargar carrito (debería estar vacío)
            cargarCarrito();
            actualizarContadorCarrito(0);
            
            // Recargar historial para que aparezca el nuevo pedido
            cargarHistorial();
        } else {
            mostrarNotificacion('❌ ' + (data.message || 'Error al crear el pedido'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
        mostrarNotificacion('❌ Error de conexión', 'error');
    });
}

// Función para mostrar modal con código de verificación
function mostrarModalPedido(numeroPedido, codigoVerificacion) {
    const modalHTML = `
        <div class="modal fade" id="modalPedidoExitoso" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-check-circle"></i> ¡Pedido Realizado!
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-receipt fa-3x text-success mb-3"></i>
                            <h4>Tu pedido ha sido confirmado</h4>
                        </div>
                        
                        <div class="alert alert-info">
                            <p class="mb-2"><strong>Número de Pedido:</strong></p>
                            <h3 class="text-primary mb-0">#${numeroPedido}</h3>
                        </div>
                        
                        <div class="alert alert-warning">
                            <p class="mb-2"><strong>Código de Verificación:</strong></p>
                            <h2 class="mb-0" style="font-size: 3rem; letter-spacing: 0.5rem; font-weight: bold;">
                                ${codigoVerificacion}
                            </h2>
                            <p class="mt-2 mb-0 text-muted">
                                <small><i class="fas fa-info-circle"></i> Proporciona este código de 4 dígitos al delivery para confirmar la entrega</small>
                            </p>
                        </div>
                        
                        <div class="mt-3">
                            <p class="text-muted">
                                <i class="fas fa-clock"></i> Tu pedido llegará en aproximadamente 30-45 minutos
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="fas fa-check"></i> Entendido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eliminar modal anterior si existe
    const modalAnterior = document.getElementById('modalPedidoExitoso');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Agregar nuevo modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalPedidoExitoso'));
    modal.show();
    
    // Limpiar modal del DOM al cerrarlo
    document.getElementById('modalPedidoExitoso').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

/**
 * Cargar historial de pedidos
 */
async function cargarHistorial() {
    try {
        const response = await fetch('/api/carrito/historial');
        if (!response.ok) {
            throw new Error('Error al cargar historial');
        }
        
        const pedidos = await response.json();
        renderizarHistorial(pedidos);
    } catch (error) {
        console.error('Error:', error);
        mostrarMensajeError('No se pudo cargar el historial de pedidos');
    }
}

/**
 * Renderizar historial de pedidos
 */
function renderizarHistorial(pedidos) {
    const lista = document.getElementById('pedidos-lista');
    const vacio = document.getElementById('pedidos-vacio');
    
    if (!pedidos || pedidos.length === 0) {
        lista.innerHTML = '';
        vacio.style.display = 'block';
        return;
    }
    
    vacio.style.display = 'none';
    
    lista.innerHTML = pedidos.map(pedido => {
        const fecha = new Date(pedido.fechaPedido).toLocaleString('es-PE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const estadoBadge = pedido.estado ? 
            '<span class="badge bg-success px-3 py-2" style="font-size: 0.85rem; border-radius: 20px;">Activo</span>' :
            '<span class="badge bg-secondary px-3 py-2" style="font-size: 0.85rem; border-radius: 20px;">Completado</span>';
        
        const verificadoBadge = pedido.verificado ?
            '<i class="fas fa-check-circle text-success"></i> Verificado' :
            '<i class="fas fa-clock text-warning"></i> Pendiente de verificación';
        
        const itemsHTML = pedido.items.map(item => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${item.cantidad}x ${item.nombrePromocion || 'Producto'}</span>
                <span class="text-muted">S/ ${item.precioTotal.toFixed(2)}</span>
            </div>
        `).join('');
        
        return `
            <div class="order-card shadow-sm mb-3" 
                 style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(0,0,0,0.08); transition: all 0.3s ease;"
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                 onmouseout="this.style.boxShadow='';">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="mb-1" style="color: #C62828; font-weight: 600;">Pedido #${pedido.codigo}</h5>
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt"></i> ${fecha}
                        </small>
                    </div>
                    ${estadoBadge}
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-barcode" style="color: #F5A623; width: 20px;"></i> 
                            <strong>Código Verificación:</strong> 
                            <span class="badge bg-dark" style="font-size: 1.2rem; letter-spacing: 0.2rem;">${pedido.codigoVerificacion}</span>
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-shield-alt" style="color: #17a2b8; width: 20px;"></i> 
                            <strong>Estado:</strong> ${verificadoBadge}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-map-marker-alt" style="color: #28a745; width: 20px;"></i> 
                            <strong>Dirección:</strong> ${pedido.direccionEntrega || 'No especificada'}
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-phone" style="color: #6c757d; width: 20px;"></i> 
                            <strong>Teléfono:</strong> ${pedido.telefonoContacto || 'No especificado'}
                        </p>
                    </div>
                </div>
                
                <!-- Detalles de los productos -->
                <div class="order-products mt-3 p-3" style="background: rgba(198,40,40,0.03); border-radius: 8px; border-left: 3px solid #F5A623;">
                    <h6 class="mb-3" style="color: #C62828;">
                        <i class="fas fa-utensils"></i> Productos (${pedido.items.length})
                    </h6>
                    ${itemsHTML}
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong style="color: #C62828; font-size: 1.1rem;">Total:</strong>
                        <strong style="color: #C62828; font-size: 1.3rem;">S/ ${pedido.total.toFixed(2)}</strong>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Escuchar cambio de sección para cargar historial
document.addEventListener('DOMContentLoaded', function() {
    // Interceptar clics en navegación
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            const section = this.getAttribute('data-section');
            if (section === 'historial') {
                cargarHistorial();
            }
        });
    });
});
</script>
</body>
</html>