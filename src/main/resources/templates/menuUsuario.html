<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Menú - FoodIx</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/modern-theme.css}">
</head>
<body>

<!-- Barra de Navegación -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/" th:href="@{/}">
            <i class="fas fa-utensils"></i> FoodIx
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="menuNav">
            <ul class="navbar-nav ms-auto">
                <!-- Botón de Tema Claro/Oscuro -->
                <li class="nav-item d-flex align-items-center">
                    <button class="theme-toggle" type="button" aria-label="Cambiar tema">
                        <i class="fas fa-sun"></i>
                        <i class="fas fa-moon"></i>
                    </button>
                </li>
                <li class="nav-item"><a class="nav-link" href="/" th:href="@{/}">Inicio</a></li>
                
                <!-- Nuevo: Trabaja con Nosotros -->
                <li class="nav-item">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-briefcase"></i> Trabaja con Nosotros
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/registro-restaurante" th:href="@{/registro-restaurante}">
                                <i class="fas fa-store"></i> Regístrate como Restaurante
                            </a></li>
                            <li><a class="dropdown-item" href="/registro-repartidor" th:href="@{/registro-repartidor}">
                                <i class="fas fa-motorcycle"></i> Regístrate como Delivery
                            </a></li>
                        </ul>
                    </div>
                </li>
                
                <li class="nav-item">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span th:text="${currentUser.name}">Usuario</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/menu" th:href="@{/menu}">
                                <i class="fas fa-utensils"></i> Mi Menú
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#perfilModal">
                                <i class="fas fa-user-cog"></i> Configurar Perfil
                            </a></li>
                            <li>
                                <form th:action="@{/logout}" method="post" style="display: inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="dropdown-item" style="background: none; border: none; cursor: pointer; text-align: left; width: 100%;">
                                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Mensajes Flash como Modales -->
<div th:replace="fragments/flash-messages :: flashMessages"></div>

<!-- Contenido Principal -->
<main class="container-fluid" style="padding-top: 90px;">
    <div class="row">
        <!-- Sidebar de navegación -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="sidebar-content">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle fa-3x"></i>
                    </div>
                    <h5 th:text="${currentUser.name + ' ' + currentUser.lastName}">Usuario</h5>
                    <p class="text-muted" th:text="${currentUser.email}">email@ejemplo.com</p>
                </div>

                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#promociones" data-section="promociones">
                            <i class="fas fa-fire"></i> Promociones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#carrito" data-section="carrito">
                            <i class="fas fa-shopping-cart"></i> 
                            Carrito 
                            <span class="badge bg-primary ms-2" th:text="${cartItemCount}" th:if="${cartItemCount > 0}">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#historial" data-section="historial">
                            <i class="fas fa-history"></i> Historial
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#perfil" data-section="perfil">
                            <i class="fas fa-user"></i> Perfil
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-9 col-lg-10 main-content">
            <!-- Sección Promociones -->
            <section id="promociones-content" class="menu-section active">
                <div class="section-header">
                    <h2><i class="fas fa-fire text-warning"></i> Promociones Especiales</h2>
                    <p class="text-muted">Descubre las mejores ofertas en comida de Chiclayo</p>
                </div>

                <!-- Filtros -->
                <div class="filters-section">
                    <form method="post" action="/menu/filter" th:action="@{/menu/filter}" class="row g-3">
                        <div class="col-md-4">
                            <label for="categoryFilter" class="form-label">Categoría</label>
                            <select class="form-select" id="categoryFilter" name="category">
                                <option value="">Todas las categorías</option>
                                <option th:each="cat : ${categories}" th:value="${cat.key}" th:text="${cat.value}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="priceFilter" class="form-label">Precio máximo</label>
                            <select class="form-select" id="priceFilter" name="maxPrice">
                                <option value="">Cualquier precio</option>
                                <option value="10">Hasta S/ 10</option>
                                <option value="20">Hasta S/ 20</option>
                                <option value="30">Hasta S/ 30</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Grid de Promociones -->
                <div class="products-grid" id="productsGrid">
                    <!-- Mensaje si no hay promociones -->
                    <div th:if="${promociones == null or promociones.isEmpty()}" class="text-center py-5">
                        <i class="fas fa-tags fa-4x text-muted mb-3"></i>
                        <h4>No hay promociones disponibles</h4>
                        <p class="text-muted">Pronto tendremos nuevas ofertas para ti</p>
                    </div>

                    <!-- Promociones -->
                    <div class="product-card" th:each="promocion : ${promociones}">
                        <img th:src="${promocion.imagenPrincipal}" th:alt="${promocion.titulo}" 
                             class="product-image" onerror="this.src='/img/default-food.jpg'">
                        <div class="product-info">
                            <span class="product-category" th:text="${promocion.categoriaPromocion}">Categoría</span>
                            <h3 class="product-name" th:text="${promocion.titulo}">Nombre de la promoción</h3>
                            <p class="product-restaurant">
                                <i class="fas fa-store"></i> 
                                <span th:text="${promocion.restaurante.nombre}">Restaurante</span>
                                <small class="text-muted ms-2" th:text="'• ' + ${promocion.restaurante.distrito.nombre}">• Distrito</small>
                            </p>
                            <p class="product-description" th:text="${promocion.descripcion}">Descripción</p>
                            
                            <!-- Tiempo restante -->
                            <div class="time-remaining mb-2" th:if="${promocion.estado == 'activa'}">
                                <small class="text-warning">
                                    <i class="fas fa-clock"></i> 
                                    <span th:text="'Válido hasta ' + ${#temporals.format(promocion.fechaFin, 'dd/MM/yyyy')}"></span>
                                </small>
                            </div>
                            
                            <div class="product-prices">
                                <span class="original-price" th:if="${promocion.precioOriginal > promocion.precioPromocional}"
                                      th:text="'S/ ' + ${#numbers.formatDecimal(promocion.precioOriginal, 1, 2)}">
                                    S/ 0.00
                                </span>
                                <span class="sale-price" th:text="'S/ ' + ${#numbers.formatDecimal(promocion.precioPromocional, 1, 2)}">
                                    S/ 0.00
                                </span>
                                <span class="discount-badge" 
                                      th:if="${promocion.precioOriginal > promocion.precioPromocional}"
                                      th:text="'-' + ${#numbers.formatDecimal(((promocion.precioOriginal - promocion.precioPromocional) / promocion.precioOriginal * 100), 0, 0)} + '%'">
                                    -0%
                                </span>
                            </div>
                            
                            <!-- Métricas de popularidad -->
                            <div class="product-metrics">
                                <small class="text-muted">
                                    <i class="fas fa-eye"></i> <span th:text="${promocion.contadorVistas}">0</span> vistas • 
                                    <i class="fas fa-shopping-bag"></i> <span th:text="${promocion.contadorPedidos}">0</span> pedidos
                                </small>
                            </div>
                            
                            <form method="post" th:action="@{/cart/add/{id}(id=${promocion.codigo})}">
                                <input type="hidden" name="tipo" value="promocion">
                                <button type="submit" class="add-to-cart-btn" 
                                        th:disabled="${promocion.estado != 'activa'}">
                                    <i class="fas fa-cart-plus"></i> 
                                    <span th:text="${promocion.estado == 'activa' ? 'Agregar al Carrito' : 'No Disponible'}">
                                        Agregar al Carrito
                                    </span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección Carrito -->
            <section id="carrito-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> Mi Carrito</h2>
                    <p class="text-muted">Revisa tus productos antes de realizar el pedido</p>
                </div>

                <!-- Carrito vacío -->
                <div th:if="${cartItems == null or cartItems.isEmpty()}" class="empty-cart text-center py-5">
                    <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                    <h4>Tu carrito está vacío</h4>
                    <p class="text-muted mb-4">¡Agrega algunas promociones deliciosas desde nuestro menú!</p>
                    <button type="button" class="btn btn-primary" onclick="showMenuSection('promociones')">
                        <i class="fas fa-utensils"></i> Ver Promociones
                    </button>
                </div>

                <!-- Carrito con productos -->
                <div class="cart-content" th:if="${cartItems != null and !cartItems.isEmpty()}">
                    <div class="cart-items">
                        <div class="cart-item" th:each="item : ${cartItems}">
                            <img th:src="${item.promocion.imagenPrincipal}" th:alt="${item.promocion.titulo}" 
                                 class="cart-item-image" onerror="this.src='/img/default-food.jpg'">
                            <div class="cart-item-info">
                                <h5 th:text="${item.promocion.titulo}">Promoción</h5>
                                <p th:text="${item.promocion.restaurante.nombre}">Restaurante</p>
                                
                                <!-- Opciones de entrega -->
                                <div class="delivery-options mb-2">
                                    <small class="text-muted">Tipo de entrega:</small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="tipoEntrega_${item.promocion.codigo}" 
                                               th:id="delivery_${item.promocion.codigo}" value="DELIVERY" checked>
                                        <label class="btn btn-outline-primary" th:for="delivery_${item.promocion.codigo}">
                                            <i class="fas fa-motorcycle"></i> Delivery
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="tipoEntrega_${item.promocion.codigo}" 
                                               th:id="pickup_${item.promocion.codigo}" value="RECOGO_TIENDA">
                                        <label class="btn btn-outline-success" th:for="pickup_${item.promocion.codigo}">
                                            <i class="fas fa-store"></i> Recoger
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="quantity-controls">
                                    <form method="post" th:action="@{/cart/update/{id}(id=${item.promocion.codigo})}" style="display: inline;">
                                        <input type="hidden" name="quantity" th:value="${item.quantity - 1}">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary" 
                                                th:disabled="${item.quantity <= 1}">-</button>
                                    </form>
                                    <span class="quantity" th:text="${item.quantity}">1</span>
                                    <form method="post" th:action="@{/cart/update/{id}(id=${item.promocion.codigo})}" style="display: inline;">
                                        <input type="hidden" name="quantity" th:value="${item.quantity + 1}">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">+</button>
                                    </form>
                                </div>
                            </div>
                            <div class="cart-item-price">
                                <p th:text="'S/ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">S/ 0.00</p>
                                <small class="text-muted" th:text="'S/ ' + ${#numbers.formatDecimal(item.promocion.precioPromocional, 1, 2)} + ' c/u'">
                                    S/ 0.00 c/u
                                </small>
                                <form method="post" th:action="@{/cart/remove/{id}(id=${item.promocion.codigo})}">
                                    <button type="submit" class="btn btn-sm btn-danger mt-1">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <!-- Información de entrega -->
                        <div class="delivery-info mb-3">
                            <h6><i class="fas fa-map-marker-alt"></i> Dirección de entrega</h6>
                            <div class="mb-2">
                                <input type="text" class="form-control" name="direccionEntrega" 
                                       th:value="${currentUser.direccion}" 
                                       placeholder="Ingresa tu dirección para delivery">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Solo para pedidos con delivery
                                </small>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" name="referenciaEntrega" rows="2" 
                                          placeholder="Referencias adicionales (opcional)"></textarea>
                            </div>
                        </div>

                        <div class="cart-total">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span th:text="'S/ ' + ${#numbers.formatDecimal(cartSubtotal, 1, 2)}">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Costo de delivery:</span>
                                <span th:text="'S/ ' + ${#numbers.formatDecimal(deliveryCost, 1, 2)}">S/ 0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <h4>Total:</h4>
                                <h4 class="text-primary" th:text="'S/ ' + ${#numbers.formatDecimal(cartTotal, 1, 2)}">S/ 0.00</h4>
                            </div>
                        </div>
                        
                        <div class="payment-methods">
                            <form method="post" action="/cart/checkout" th:action="@{/cart/checkout}" id="checkoutForm">
                                <div class="mb-3">
                                    <label class="form-label">Método de pago:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" value="efectivo" id="efectivo" checked>
                                        <label class="form-check-label" for="efectivo">
                                            <i class="fas fa-money-bill-wave"></i> Efectivo
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" value="tarjeta" id="tarjeta">
                                        <label class="form-check-label" for="tarjeta">
                                            <i class="fas fa-credit-card"></i> Tarjeta
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" value="yape" id="yape">
                                        <label class="form-check-label" for="yape">
                                            <i class="fas fa-mobile-alt"></i> Yape
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" value="plin" id="plin">
                                        <label class="form-check-label" for="plin">
                                            <i class="fas fa-mobile-alt"></i> Plin
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Notas especiales -->
                                <div class="mb-3">
                                    <label for="notasEspeciales" class="form-label">Notas especiales (opcional)</label>
                                    <textarea class="form-control" id="notasEspeciales" name="notasEspeciales" 
                                              rows="2" placeholder="Instrucciones especiales para tu pedido..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-credit-card"></i> Realizar Pedido
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección Historial -->
            <section id="historial-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Historial de Pedidos</h2>
                    <p class="text-muted">Revisa tus pedidos anteriores</p>
                </div>

                <div class="orders-list" th:if="${pedidos != null and !pedidos.isEmpty()}">
                    <div class="order-card" th:each="pedido : ${pedidos}">
                        <div class="order-header">
                            <h5 th:text="${pedido.numeroPedido}">Número de pedido</h5>
                            <span class="badge" 
                                  th:classappend="${pedido.estadoPedido.nombre == 'ENTREGADO'} ? 'bg-success' : 
                                                 (${pedido.estadoPedido.nombre == 'EN_CAMINO'} ? 'bg-primary' :
                                                 (${pedido.estadoPedido.nombre == 'EN_PREPARACION'} ? 'bg-warning' :
                                                 (${pedido.estadoPedido.nombre == 'PENDIENTE'} ? 'bg-secondary' : 'bg-danger')))"
                                  th:text="${pedido.estadoPedido.nombre}">Estado</span>
                        </div>
                        <div class="order-details">
                            <p><strong>Fecha:</strong> <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">Fecha</span></p>
                            <p><strong>Restaurante:</strong> <span th:text="${pedido.restaurante.nombre}">Restaurante</span></p>
                            <p><strong>Total:</strong> <span th:text="'S/ ' + ${#numbers.formatDecimal(pedido.total, 1, 2)}">S/ 0.00</span></p>
                            <p><strong>Método de pago:</strong> <span th:text="${pedido.metodoPago}">Método</span></p>
                            <p><strong>Tipo de entrega:</strong> 
                                <span th:text="${pedido.tipoEntrega.nombre}">Tipo</span>
                                <span th:if="${pedido.tipoEntrega.nombre == 'DELIVERY' && pedido.repartidor}" 
                                      class="text-muted">• Repartidor: <span th:text="${pedido.repartidor.usuario.nombre}"></span></span>
                            </p>
                            
                            <!-- Detalles de los productos -->
                            <div class="order-products mt-2">
                                <h6>Productos:</h6>
                                <div th:each="detalle : ${pedido.detalles}">
                                    <small th:text="${detalle.cantidad} + 'x ' + ${detalle.promocion.titulo} + ' - S/ ' + ${#numbers.formatDecimal(detalle.subtotal, 1, 2)}"></small>
                                </div>
                            </div>
                            
                            <!-- Acciones según estado -->
                            <div class="order-actions mt-2" th:if="${pedido.estadoPedido.nombre == 'ENTREGADO'}">
                                <button class="btn btn-sm btn-outline-primary" th:onclick="|calificarPedido(${pedido.codigo})|">
                                    <i class="fas fa-star"></i> Calificar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${pedidos == null or pedidos.isEmpty()}" class="empty-history text-center py-5">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <h4>No tienes pedidos anteriores</h4>
                    <p class="text-muted">Tus pedidos aparecerán aquí una vez que realices tu primera compra</p>
                </div>
            </section>

            <!-- Sección Perfil -->
            <section id="perfil-content" class="menu-section">
                <div class="section-header">
                    <h2><i class="fas fa-user"></i> Mi Perfil</h2>
                    <p class="text-muted">Administra tu información personal</p>
                </div>

                <div class="profile-info">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-card">
                                <h5>Información Personal</h5>
                                <p><strong>Nombre:</strong> <span th:text="${currentUser.name + ' ' + currentUser.lastName}">Nombre completo</span></p>
                                <p><strong>Email:</strong> <span th:text="${currentUser.email}">email@ejemplo.com</span></p>
                                <p><strong>Teléfono:</strong> <span th:text="${currentUser.phone ?: 'No especificado'}">Teléfono</span></p>
                                <p><strong>Dirección:</strong> <span th:text="${currentUser.address ?: 'No especificada'}">Dirección</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <h5>Estadísticas</h5>
                                <p><strong>Pedidos realizados:</strong> <span th:text="${pedidos != null ? pedidos.size() : 0}">0</span></p>
                                <p><strong>Productos en carrito:</strong> <span th:text="${cartItemCount ?: 0}">0</span></p>
                                <p><strong>Total gastado:</strong> 
                                    <span th:if="${pedidos != null and !pedidos.isEmpty()}" 
                                          th:text="'S/ ' + ${#numbers.formatDecimal(pedidos.![total].sum(), 1, 2)}">S/ 0.00</span>
                                    <span th:if="${pedidos == null or pedidos.isEmpty()}">S/ 0.00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<!-- Botón Flotante del Carrito -->
<div class="floating-cart-btn" id="floatingCartBtn" style="display: none;">
    <button class="btn btn-primary btn-floating" data-bs-toggle="modal" data-bs-target="#cartPreviewModal">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="floatingCartCount">0</span>
        <div class="cart-total" id="floatingCartTotal">S/ 0.00</div>
    </button>
</div>

<!-- Modal de Preview del Carrito -->
<div class="modal fade" id="cartPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart"></i> Mi Carrito - Resumen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cartPreviewContent">
                    <!-- Contenido dinámico del carrito -->
                    <div class="text-center text-muted py-4" id="emptyCartMessage">
                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                        <p>Tu carrito está vacío</p>
                        <p>¡Agrega algunos productos deliciosos!</p>
                    </div>
                    
                    <div id="cartItemsList" style="display: none;">
                        <!-- Los items se cargarán aquí dinámicamente -->
                    </div>
                    
                    <div id="cartSummary" style="display: none;">
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Total a pagar:</h5>
                            <h4 class="text-primary mb-0" id="modalCartTotal">S/ 0.00</h4>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                                    <i class="fas fa-arrow-left"></i> Seguir Comprando
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-success w-100" id="proceedToCheckout">
                                    <i class="fas fa-credit-card"></i> Realizar Pago
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Perfil -->
<div class="modal fade" id="perfilModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-cog"></i> Configurar Perfil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/auth/update-profile" th:action="@{/auth/update-profile}" method="post">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Actualiza tu información personal
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileName" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="profileName" name="name" 
                                   th:value="${currentUser?.name}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profileLastName" class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="profileLastName" name="lastName" 
                                   th:value="${currentUser?.lastName}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="profileEmail" name="email" 
                                   th:value="${currentUser?.email}" required readonly>
                            <div class="form-text">El email no se puede cambiar</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profilePhone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="profilePhone" name="phone" 
                                   th:value="${currentUser?.phone}" placeholder="Ej: +51 987654321">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileBirthdate" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="profileBirthdate" name="birthdate" 
                                   th:value="${currentUser?.birthdate}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profileNewPassword" class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="profileNewPassword" name="newPassword" 
                                   placeholder="Dejar vacío para no cambiar" minlength="6">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="profileAddress" class="form-label">Dirección</label>
                        <textarea class="form-control" id="profileAddress" name="address" rows="2" 
                                  th:text="${currentUser?.address}" placeholder="Ej: Av. Balta 123, Chiclayo"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/theme-toggle.js}"></script>
<script th:src="@{/js/main.js}"></script>
<script>
// JavaScript para funcionalidades específicas del menú
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar botón flotante del carrito
    updateFloatingCart();
    
    // Manejar cambios en tipo de entrega
    document.querySelectorAll('input[name^="tipoEntrega_"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateCartSummary();
        });
    });

    // Navegación entre secciones
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('href').substring(1);
            showMenuSection(section);
        });
    });
});

function showMenuSection(sectionName) {
    // Ocultar todas las secciones
    document.querySelectorAll('.menu-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remover active de todos los links
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar sección seleccionada
    document.getElementById(sectionName + '-content').classList.add('active');
    
    // Activar link correspondiente
    document.querySelector(`.sidebar .nav-link[href="#${sectionName}"]`).classList.add('active');
}

function updateFloatingCart() {
    fetch('/cart/summary')
        .then(response => response.json())
        .then(data => {
            const floatingBtn = document.getElementById('floatingCartBtn');
            const cartCount = document.getElementById('floatingCartCount');
            const cartTotal = document.getElementById('floatingCartTotal');
            
            if (data.itemCount > 0) {
                floatingBtn.style.display = 'block';
                cartCount.textContent = data.itemCount;
                cartTotal.textContent = 'S/ ' + data.total.toFixed(2);
            } else {
                floatingBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.log('Error al cargar resumen del carrito:', error);
        });
}

function updateCartSummary() {
    // Recalcular costos basado en tipo de entrega seleccionado
    const deliveryItems = document.querySelectorAll('input[name^="tipoEntrega_"]:checked[value="DELIVERY"]').length;
    const deliveryCost = deliveryItems > 0 ? 5.90 : 0;
    
    // Actualizar el elemento que muestra el costo de delivery
    const deliveryCostElement = document.querySelector('[th\\:text*="deliveryCost"]');
    if (deliveryCostElement) {
        deliveryCostElement.textContent = 'S/ ' + deliveryCost.toFixed(2);
    }
    
    // Actualizar total
    const cartTotalElement = document.querySelector('[th\\:text*="cartTotal"]');
    const cartSubtotalElement = document.querySelector('[th\\:text*="cartSubtotal"]');
    
    if (cartTotalElement && cartSubtotalElement) {
        const subtotalText = cartSubtotalElement.textContent.replace('S/ ', '');
        const subtotal = parseFloat(subtotalText) || 0;
        const newTotal = subtotal + deliveryCost;
        cartTotalElement.textContent = 'S/ ' + newTotal.toFixed(2);
    }
}

function calificarPedido(pedidoId) {
    const rating = prompt('Califica este pedido (1-5 estrellas):');
    if (rating && rating >= 1 && rating <= 5) {
        const comentario = prompt('Comentario adicional (opcional):') || '';
        
        fetch(`/pedidos/${pedidoId}/calificar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('[name="_csrf"]').value
            },
            body: JSON.stringify({
                calificacion: parseInt(rating),
                comentario: comentario
            })
        }).then(response => {
            if (response.ok) {
                alert('¡Gracias por tu calificación!');
                location.reload();
            } else {
                alert('Error al enviar la calificación');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error al enviar la calificación');
        });
    }
}
</script>
</body>
</html>